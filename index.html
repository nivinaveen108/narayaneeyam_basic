<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="description" content="Interactive NƒÅrƒÅya·πáƒ´yam Player ‚Äî synchronized audio, verse display, and transliteration.">
    <meta name="theme-color" content="#0f0f10">
    <title>NƒÅrƒÅya·πáƒ´yam Player ‚Äî Go to & Transliteration</title>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&family=Tiro+Devanagari+Hindi:wght@400;600&family=Noto+Serif+Devanagari:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="data:,">
    <style>
        :root{
         /* base tokens (light fallback) */
         --ui-font: "Poppins", "Segoe UI", system-ui, -apple-system, sans-serif;
         --deva-font: "Tiro Devanagari Hindi", "Noto Serif Devanagari", serif;
         /* Apple-music-like accents (dark default uses pink/coral) */
         --accent: #ff2d55;           /* bright pink accent */
         --accent-soft: rgba(255,45,85,0.12);
         --glass-strong: rgba(22,22,24,0.7);
         --glass-soft: rgba(28,28,30,0.55);
         --surface: rgba(18,18,20,0.7);
         --muted: #9b9b9f;
         --text-primary: #e9e9eb;
         --text-secondary: #c7c7cb;
         --shadow: rgba(0,0,0,0.6);
         --page-bg: linear-gradient(180deg,#08080a 0%, #0e0e10 100%);
         --glass-border: rgba(255,255,255,0.06);
         --control-bg: rgba(255,255,255,0.03);
         --is-dark: 1; /* 1 = dark mode, 0 = light mode */
         --dashakam-color: #ff2d55;      /* default dark mode color for Dashakam title */
         --mahapraana-color: var(--accent);
	 --verse-font-scale: 1;       /* main Devanagari verse */
	--splitwords-font-scale: 0.75; /* slightly smaller than verse */
	--meaning-font-scale: 1.0;    /* smaller English/Malayalam */
    /* default dark mode color for Mahapraana highlighting */

         }
         /* Light theme overrides (applied when body has .light-theme) */
         body.light-theme {
         --accent: #ff2d55;
         --accent-soft: rgba(255,45,85,0.08);
         --glass-strong: rgba(255,255,255,0.9);
         --glass-soft: rgba(255,255,255,0.82);
         --surface: rgba(255,255,255,0.85);
         --muted: #55606a;
         --text-primary: #0b0b0b;
         --text-secondary: #3a3a3c;
         --shadow: rgba(0,0,0,0.08);
         --page-bg: linear-gradient(180deg,#fafafa 0%, #f4f4f6 100%);
         --glass-border: rgba(0,0,0,0.06);
         --control-bg: rgba(245,245,247,0.8);
         --dashakam-color: #d60045;      /* readable version on light bg */
    	   --mahapraana-color: var(--accent);

         }
         /* smooth transitions */
         * { box-sizing: border-box; transition: background-color .18s ease, color .18s ease, border-color .18s ease, box-shadow .18s ease, transform .12s ease; }
         html,body{ height:100%; margin:0; padding:0; }
         /* overall page */
         body{
         font-family: var(--ui-font);
         background: var(--page-bg);
         color: var(--text-primary);
         padding: 22px;
         -webkit-font-smoothing:antialiased;
         -moz-osx-font-smoothing:grayscale;
         -webkit-user-select:none;
         }
         /* heading */
         h1{
         text-align:center;
         margin:0 0 12px 0;
         font-weight:600;
         color:var(--text-primary);
         letter-spacing:-0.4px;
         font-size:1.25rem;
         }
         /* keep the same top config row layout ‚Äî we only restyle visuals */
         #configRow{
         display:flex;
         justify-content:center;
         align-items:center;
         margin-bottom:14px;
         /* Apple style glass */
         background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
         border-radius:14px;
         padding:10px 14px;
         box-shadow: 0 6px 22px var(--shadow);
         border: 1px solid var(--glass-border);
         }
         /* style selector wrapper (unchanged layout) */
         #styleSelectorRow{
         display:flex;
         align-items:center;
         justify-content:center;
         gap:18px;
         flex-wrap:wrap;
         padding:6px 10px;
         border-radius:10px;
         background: transparent;
         }
         /* keep sizes & spacing of your controls exactly the same;
         only adjust look: rounded, subtle inner glow + border */
         #speedBtn { min-width:70px; justify-content:space-evenly; }
         /* theme dots, fonts, size controls ‚Äî preserve structure */
         .theme-dots { display:flex; gap:8px; align-items:center; }
         .theme-dot[data-theme="dark"]   { background-color: #1c1c1e; border: 1px solid #555; }
         .theme-dot[data-theme="light"]  { background-color: #f2f2f7; border: 1px solid #c7c7cb; }
         .theme-dot[data-theme="pink"]   { background-color: #ff2d55; }
         .theme-dot[data-theme="green"]  { background-color: #32d74b; }
         .theme-dot[data-theme="orange"] { background-color: #ff9f0a; }
         .theme-dot[data-theme="blue"]   { background-color: #0a84ff; }
         .theme-dot[data-theme="purple"] { background-color: #bf5af2; }
         .theme-dot[data-theme="brown"]  { background-color: #a0522d; } /* Sienna */
         .theme-dot[data-theme="teal"]   { background-color: #008080; }
         .theme-dot[data-theme="charcoal"]{ background-color: #333333; }
         .theme-dot[data-theme="maroon"] { background-color: #800000; }
         .theme-dot[data-theme="custom"] { background-color: #ffcc00; } /* or any custom color */
         .theme-dot:hover { transform: scale(1.08); filter: brightness(1.08); }
         .theme-dot:hover{ transform:scale(1.08); filter:brightness(1.08); }
         /* font swatches */
         .font-options { display:flex; gap:8px; }
         .font-swatch{
         width:34px; height:34px; border-radius:8px;
         display:flex; align-items:center; justify-content:center;
         cursor:pointer; font-weight:700; font-size:.9rem;
         border: 1px solid rgba(255,255,255,0.04);
         background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.015));
         box-shadow: 0 6px 18px rgba(0,0,0,0.45) inset;
         }
         .font-swatch.active{ outline: 2px solid rgba(255,255,255,0.06); box-shadow: 0 6px 22px rgba(0,0,0,0.65) inset; }
         /* font size controls */
         .font-size-controls { display:flex; align-items:center; gap:6px; }
         .font-size-controls button{
         border-radius:8px; padding:4px 10px; font-weight:700;
         border: 1px solid rgba(255,255,255,0.04);
         background: transparent; color:var(--text-primary);
         }
         /* audio control panel - keep same size and layout, change visual */
         #audioControls{
         max-width:1100px;
         margin:0 auto 8px;
         display:flex; flex-direction:column; gap:8px;
         padding:12px;
         border-radius:14px;
         /* glass surface */
         background: linear-gradient(180deg, var(--surface), rgba(255,255,255,0.02));
         border:1px solid var(--glass-border);
         box-shadow: 0 10px 40px rgba(0,0,0,0.55);
         }
         /* control rows - identical layout */
         .control-row{ display:flex; align-items:center; justify-content:center; gap:10px; flex-wrap:wrap; }
         /* time-row keep exact layout and sizes */
         .time-row{
         display:flex; align-items:center; justify-content:space-between;
         gap:12px; width:100%;
         border-top:1px solid rgba(255,255,255,0.04);
         padding-top:10px;
         }
         .time-left, .time-right{ display:flex; align-items:center; gap:8px; }
         /* navigate rows - identical layout */
         .navigate-row{ display:flex; align-items:center; justify-content:center; gap:10px; flex-wrap:wrap; }

/* MahƒÅprƒÅ·πáa highlighting */
.mahapraana {
    color: var(--mahapraana-color, var(--accent));
    font-weight: bold;
    /* optional: subtle shadow for depth */
    text-shadow: 1px 1px 2px rgba(0,0,0,0.15);
}


         /* Buttons - preserve sizes but restyle visuals */
         button{
         cursor:pointer;
         font-weight:600;
         border-radius:12px;
         padding:8px 12px;
         min-height:40px;
         background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
         border: 1px solid rgba(255,255,255,0.04);
         color: var(--text-primary);
         box-shadow: 0 6px 16px rgba(0,0,0,0.5) inset;
         }
         button span, .btn-label-small {
         color: var(--text-primary);
         }
         /* icon buttons */
         button.icon-btn{ width:54px; height:44px; padding:0; display:flex; align-items:center; justify-content:center; font-size:1.05rem; }
         /* active state: dark pill with accent glow for Apple-like feel */
         button.active{
         background: linear-gradient(180deg, rgba(0,0,0,0.75), rgba(0,0,0,0.6));
         color: #fff;
         border: 1px solid rgba(255,255,255,0.06);
         box-shadow: 0 6px 28px rgba(0,0,0,0.65), 0 0 18px rgba(255,45,85,0.18);
         }
         /* hover */
         button:hover{
         transform: translateY(-1px);
         box-shadow: 0 10px 28px rgba(0,0,0,0.6), 0 0 12px rgba(255,45,85,0.06);
         }
         /* focus visible */
         button:focus-visible{
         outline: 3px solid rgba(255,45,85,0.18);
         outline-offset:2px;
         }
         /* goto panel keep dimensions and layout same ‚Äî visuals changed */
         #gotoWrapper{ position:relative; display:flex; align-items:center; }
         #gotoToggle{ background:transparent; border:none; color:var(--text-primary); font-weight:700; padding:6px 8px; cursor:pointer; }
         #gotoPanel{
         position:absolute; right:0; top:34px; width:520px; max-width:calc(100vw - 44px);
         background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
         border-radius:10px; padding:10px; display:none; z-index:60;
         border:1px solid var(--glass-border);
         box-shadow: 0 18px 40px rgba(0,0,0,0.6);
         }
         .group-grid{ display:flex; flex-wrap:wrap; gap:8px; justify-content:center; }
         .group-select{
         border-radius:8px; padding:8px 12px; font-weight:700; min-width:120px; text-align:center;
         cursor:pointer; border:1px solid rgba(255,255,255,0.03);
         background:transparent;
         color: var(--text-primary);
         }
         .group-select:hover{ background: var(--accent-soft); box-shadow: 0 8px 18px rgba(0,0,0,0.6) inset; }
         /* time info text (unchanged layout) */
         #timeDisplay, 

/* Dashakam title */
body.light-theme #currentInfo {
    color: var(--dashakam-color);
    font-weight: 800;
    font-size: 1.32 rem;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
text-align: center; /* Centers the text horizontally */
}

body:not(.light-theme) #currentInfo {
    color: var(--dashakam-color);
    font-weight: 800;
    font-size: 1.32 rem;
    text-shadow: 1px 1px 2px rgba(255,255,255,0.3);
text-align: center; /* Centers the text horizontally */
}

         /* SUBTITLE CONTAINER - IMPORTANT: DO NOT CHANGE SIZE/STRUCTURE */
         /* exactly preserve max-width, margin, padding, border, border-radius, etc.  */
         #subtitleContainer{
         position: relative;
         max-width: 1100px;
         margin: 12px auto 0;
         padding: 18px;
         border: 3px dashed var(--glass-border);         /* originally var(--primary-dark) ‚Äî restyled to glass-border */
         border-radius: 12px;
         background: rgba(255,255,255,0.02);              /* subtle dark glass */
         box-shadow: 0 8px 24px rgba(0,0,0,0.65);
         text-align: center;
         line-height: 1.9;
         }
         #overlayImage {
         position: absolute;
         top: 0; left: 0; right: 0; bottom: 0;
         background: url('Guruvayoorappan.png') center center no-repeat;
         background-size: contain;
         opacity: 0.03;       /* adjust as needed */
         mix-blend-mode: normal;  /* or just remove this line */
         pointer-events: none;
         transition: opacity 1.2s ease;
         z-index: 15;
         }
         /* visible state */
         #subtitleContainer.show-overlay #overlayImage {
         opacity: var(--subtitle-overlay-opacity, 0.11);
         }
         /* Inside content... keep fonts & sizes exactly as before */
         #verse, #splitWords{ font-family: var(--deva-font); letter-spacing:.02em; text-align:center; }
         #verse{
    font-size: calc(clamp(1.8rem, 3vw, 2.4rem) * var(--font-scale) * var(--verse-font-scale));
    font-weight:700;
    color: var(--text-primary);
    margin-bottom:14px;
    text-align: center;
    letter-spacing: .02em;
}

#splitWords{
    font-size: calc(var(--verse-size) * 0.75 * var(--font-scale) * var(--splitwords-font-scale));
    font-style: italic;
    color: var(--accent);
    margin-bottom:12px;
    text-align: center;
    letter-spacing: .02em;
	display: none;
	
}

#meaning{
    font-family:var(--ui-font);
    font-size: calc(1.25rem * var(--font-scale) * var(--meaning-font-scale));
    color:var(--text-secondary);
    max-width:960px;
    margin:0 auto;
    text-align:justify;
    line-height:1.8;
    background: rgba(255,255,255,0.01);
    padding:12px 14px;
    border-radius:10px;
    border:1px solid rgba(255,255,255,0.02);
	display: none;
	
}
         /* audio element styling unchanged layout */
         audio{ display:block; margin:10px auto 0; width:100%; max-width:1100px; accent-color:var(--accent); }
         /* small theme-toggle button placed unobtrusively (keeps configRow layout) */
         #themeModeToggle{
         border-radius:999px; padding:6px 10px; font-weight:600; min-height:36px;
         background: transparent; border:1px solid rgba(255,255,255,0.04);
         color:var(--text-primary);
         display:flex; align-items:center; gap:8px;
         }
         /* Button text color in light theme */
         body.light-theme button {
         color: #000; /* pure black text */
         border-color: rgba(0,0,0,0.1); /* optional: subtle border for visibility */
         }
         /* Optional: hover effect in light mode */
         body.light-theme button:hover {
         background: rgba(0,0,0,0.04);
         box-shadow: inset 0 6px 18px rgba(0,0,0,0.1);
         }
         /* tiny pill indicator for accent */
         .accent-pill{
         width:10px; height:10px; border-radius:50%; background:var(--accent); box-shadow:0 6px 14px rgba(255,45,85,0.22);
         }
         /* === FIX: ensure A‚àí / A+ font-size buttons follow theme text color === */
         .font-size-controls button {
         color: var(--text-primary) !important;
         border-color: rgba(255,255,255,0.08) !important;
         background: transparent !important;
         }

body.light-theme #subtitleContainer {
    background: rgba(255,255,255,0.85);
    border: 1px solid rgba(0,0,0,0.06);
}

body.light-theme #verse {
    font-size: calc(clamp(1.8rem, 3vw, 2.4rem) * var(--font-scale) * var(--verse-font-scale));
}

body.light-theme #splitWords {
    font-size: calc(var(--verse-size) * 0.7 * var(--font-scale) * var(--splitwords-font-scale));
}

body.light-theme #meaning {
    font-size: calc(1.12rem * var(--font-scale) * var(--meaning-font-scale));
}


#muteBtn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px; /* match your other icon buttons */
    border-radius: 12px;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border: 1px solid rgba(255,255,255,0.04);
    box-shadow: 0 6px 16px rgba(0,0,0,0.5) inset;
}

#muteBtn:hover {
    transform: translateY(-1px);
    box-shadow: 0 10px 28px rgba(0,0,0,0.6), 0 0 12px rgba(255,45,85,0.06);
}

#volumeSlider {
    width: 80px; /* adjust to fit nicely */
    height: 6px;
    border-radius: 6px;
    background: rgba(255,255,255,0.03);
    -webkit-appearance: none;
    cursor: pointer;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
}

#volumeSlider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: var(--accent);
    box-shadow: 0 2px 4px rgba(0,0,0,0.4);
}

#volumeSlider::-moz-range-thumb {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: var(--accent);
    box-shadow: 0 2px 4px rgba(0,0,0,0.4);
}


.top-button {
  border-radius: 12px;
  padding: 8px 12px;
  font-size: 1rem;
  font-weight:600;
  border: 1px solid rgba(255,255,255,0.04);
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  color: var(--text-primary);
  box-shadow: 0 6px 16px rgba(0,0,0,0.5) inset;
  cursor: pointer;
  margin-left:6px;
  transition: transform 0.15s ease, box-shadow 0.2s ease;
}

.top-button:hover {
  transform: scale(1.05);
  box-shadow: 0 10px 28px rgba(0,0,0,0.6), 0 0 12px rgba(255,45,85,0.06);
}

/* Unified Premium Glass Buttons (consistent with the theme) */
#homeBtn,
#vsnBtn {
  font-family: var(--ui-font);
  padding: 10px 16px;
  border-radius: 12px;

  /* Glass look */
  background: linear-gradient(
    180deg,
    rgba(255,255,255,0.04),
    rgba(255,255,255,0.02)
  );
  border: 1px solid var(--glass-border);
  color: var(--text-primary);

  /* Soft inner + outer shadow */
  box-shadow:
    inset 0 6px 20px rgba(0,0,0,0.45),
    0 6px 22px rgba(0,0,0,0.55);

  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);

  transition: all 0.22s ease;
  cursor: pointer;
}

/* Hover ‚Äî subtle lift */
#homeBtn:hover,
#vsnBtn:hover {
  transform: translateY(-2px);
  box-shadow:
    inset 0 6px 22px rgba(0,0,0,0.55),
    0 10px 28px rgba(0,0,0,0.6),
    0 0 14px var(--accent-soft);
}

/* Pressed */
#homeBtn:active,
#vsnBtn:active {
  transform: scale(0.97);
  box-shadow:
    inset 0 4px 14px rgba(0,0,0,0.6),
    0 2px 6px rgba(0,0,0,0.4);
}

/* VSN button keeps its center alignment exactly as before */
#vsnBtn {
  position: relative;
  margin: 0 auto;
  display: block;
}

/* Home button stays as-is (top-left) */
#homeBtn {
  position: relative;
  top: 0;
  left: 0;
}

.info-buttons-wrapper {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
  margin-top: 6px;
}

/* Darkened blur background */
.credits-modal {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.55);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 3000;
}

/* Modal window */
.credits-content {
  background: linear-gradient(
    180deg,
    var(--glass-strong, rgba(255,255,255,0.35)),
    var(--glass-soft, rgba(255,255,255,0.15))
  );
  border: 1px solid var(--glass-border, rgba(255,255,255,0.4));
  border-radius: 14px;
  padding: 24px 28px;
  width: 90%;
  max-width: 420px;
  box-shadow: 0 18px 40px rgba(0, 0, 0, 0.6);
  color: var(--text-primary);
  text-align: center;
}

/* Close button */
.modal-close-btn {
  margin-top: 20px;
  padding: 8px 14px;
  border-radius: 8px;
  background: rgba(255,255,255,0.08);
  border: 1px solid rgba(255,255,255,0.2);
  color: var(--text-primary);
  cursor: pointer;
  transition: 0.2s ease;
}

.modal-close-btn:hover {
  transform: scale(1.05);
}


/* Fix About & Credits button text in light theme */
body.light-theme .top-button,
body.light-theme .top-button .icon-wrapper,
body.light-theme .top-button .icon-wrapper i,
body.light-theme .top-button .icon-wrapper .icon-text {
    color: #111 !important; /* ensures dark text on light background */
    border-color: rgba(0,0,0,0.1);
}

body.light-theme .top-button:hover {
    background: rgba(0,0,0,0.04);
    box-shadow: inset 0 6px 18px rgba(0,0,0,0.1);
}



         body.light-theme .font-size-controls button {
         color: var(--text-primary) !important;
         border-color: rgba(0,0,0,0.1) !important;
         }
         /* hide scrollbar (kept) */
         ::-webkit-scrollbar{ display:none; }
         /* responsive - keep same breakpoints and sizes */
       @media (max-width:820px){
    #verse {
        font-size: calc(1.8rem * var(--font-scale) * var(--verse-font-scale));
    }
    #splitWords {
        font-size: calc(1.4rem * var(--font-scale) * var(--splitwords-font-scale));
		display: none;
    }
    #meaning {
        font-size: calc(1.15rem * var(--font-scale) * var(--meaning-font-scale));
		display: none;
    }
         .group-select{ min-width:100px; font-size:.95rem; padding:7px 10px; }
         #gotoPanel{ width: calc(100vw - 32px); left:8px; right:8px; top:44px; }
         }
    </style>
</head>

<body>
    <main>
        <h1>NƒÅrƒÅya·πáƒ´yam Player</h1>
        <!-- top config row - same layout; theme toggle added unobtrusively -->
        <div id="configRow">
            <div id="styleSelectorRow">
                <!-- Theme dots preserved -->
                <div id="themeDots" class="theme-dots" aria-hidden="true">
                    <button class="theme-dot" data-theme="dark" aria-label="Dark theme"></button>
                    <button class="theme-dot" data-theme="light" aria-label="Light theme"></button>
                    <button class="theme-dot" data-theme="pink" aria-label="Pink theme"></button>
                    <button class="theme-dot" data-theme="purple" aria-label="Purple theme"></button>
                    <button class="theme-dot" data-theme="blue" aria-label="Blue theme"></button>
                    <button class="theme-dot" data-theme="orange" aria-label="Orange theme"></button>
                </div>
                <div class="config-divider" aria-hidden="true" style="width:1px;height:26px;background:transparent;"></div>
                <div id="fontSizeControls" class="font-size-controls" aria-label="Font size controls">
                    <button id="fontSmaller" title="Decrease font size">A‚àí</button>
                    <button id="fontLarger" title="Increase font size">A+</button>
                </div>
                <!-- UI font swatches -->
                <div id="uiFontOptions" class="font-options" aria-label="UI font options">
                    <div class="font-swatch" data-font='"Poppins", "Segoe UI", sans-serif' style="font-family:'Poppins',sans-serif;">Po</div>
                    <div class="font-swatch" data-font='"Roboto", "Segoe UI", sans-serif' style="font-family:'Roboto',sans-serif;">Ro</div>
                    <div class="font-swatch" data-font='"Merriweather", serif' style="font-family:'Merriweather',serif;">Me</div>
                </div>
                <!-- Devanagari font swatches -->
                <div id="devaFontOptions" class="font-options" aria-label="Devanagari font options">
                    <div class="font-swatch" data-font='"Tiro Devanagari Hindi", serif' style="font-family:'Tiro Devanagari Hindi',serif;">‡§§‡§ø</div>
                    <div class="font-swatch" data-font='"Noto Serif Devanagari", serif' style="font-family:'Noto Serif Devanagari',serif;">‡§®‡•ã</div>
                    <div class="font-swatch" data-font='"Mukta Vaani", sans-serif' style="font-family:'Mukta Vaani',sans-serif;">‡§Æ‡•Å</div>
                </div>
                <!-- Theme mode toggle (dark/light) - placed in same row, unobtrusive -->
                <button id="themeModeToggle" title="Toggle Light / Dark theme" aria-pressed="false" style="margin-left:8px;">
                    <span class="accent-pill" aria-hidden="true"></span>
                    <span id="themeModeLabel" style="font-size:.92rem;">Dark</span>
                </button>
                <!-- Home and VSN buttons -->
                <!-- <button id="homeBtn" class="top-button" title="Go to Home">üè†</button> -->
                <button id="vsnBtn" class="top-button" title="Vishnu Sahasranamam">
                    <div class="icon-wrapper">
                        <i class="fas fa-hands-pray"></i>
                        <span class="icon-text">Vishnu Sahasranaamam</span>
                    </div>
                </button>

                <button id="homeBtn" title="Home">
                    <div class="icon-wrapper">
                        <i class="fa-solid fa-house"></i>
                        <span class="icon-text">Home</span>
                    </div>
                </button>


            </div>
        </div>
        <!-- audio controls - layout completely preserved -->
        <div id="audioControls" aria-label="Audio controls">
            <!-- Main controls row -->
            <div class="control-row">
                <!-- -10 Dashakam -->
                <button id="playPauseBtn" class="icon-btn" aria-label="Play or Pause">
                    <i class="fas fa-play"></i>
                </button>
                <div id="muteBtn" class="icon-btn" title="Volume" aria-label="Adjust Volume">
    <i class="fas fa-volume-up"></i>
    <input type="range" id="volumeSlider" min="0" max="100" value="25">
</div>
                <button id="speedBtn" class="icon-btn" title="Change Speed" aria-label="Change Playback Speed">
                    <i class="fas fa-tachometer-alt"></i>
                </button>
                <button id="repeatVerseBtn" class="icon-btn" title="Repeat Verse" aria-label="Repeat Verse">
                    <i class="fas fa-redo"></i>
                </button>
                <button id="repeatDashakamBtn" class="icon-btn" title="Repeat Dashakam" aria-label="Repeat Dashakam">
                    <i class="fas fa-infinity"></i>
                </button>
		
                <div id="infoButtonsWrapper" class="info-buttons-wrapper">
                    <button id="aboutBtn" class="top-button" title="About">
                        <div class="icon-wrapper">
                            <i class="fas fa-question-circle"></i>
                            <span class="icon-text">About</span>
                        </div>
                    </button>

                    <button id="creditsBtn" class="top-button" title="Credits">
                        <div class="icon-wrapper">
                            <i class="fas fa-info-circle"></i>
                            <span class="icon-text">Credits</span>
                        </div>
                    </button>
			<div id="timeDisplay" style="font-size: 13px;">Elapsed: 00:00 | Remaining: 00:00 | Total Elapsed: 00:00 | Total Remaining: 00:00</div>
                </div>


            </div>
            <div class="navigate-row">
                <button id="translitToggle">Devanagari</button>
                <button id="minus10DashakamBtn" class="btn-with-label" aria-label="<< -10">
                    <i class="fas fa-backward"></i>
                    <span class="btn-label-small">‚àí10</span>
                </button>
                <button id="prevDashakamBtn" class="btn-with-label" aria-label="Previous Dashakam">
                    <i class="fas fa-step-backward"></i>
                    <span class="btn-label-small">Dashakam</span>
                </button>
                <button id="prevVerseBtn" class="btn-with-label" aria-label="Previous Verse">
                    <i class="fas fa-backward"></i>
                    <span class="btn-label-small">Verse</span>
                </button>
                <button id="nextVerseBtn" class="btn-with-label" aria-label="Next Verse">
                    <span class="btn-label-small">Verse</span>
                    <i class="fas fa-forward"></i>
                </button>
                <button id="nextDashakamBtn" class="btn-with-label" aria-label="Next Dashakam">
                    <span class="btn-label-small">Dashakam</span>
                    <i class="fas fa-step-forward"></i>
                </button>
                <!-- +10 Dashakam -->
                <button id="plus10DashakamBtn" class="btn-with-label" aria-label=" +10 >>">
                    <span class="btn-label-small">+10</span>
                    <i class="fas fa-forward"></i>
                </button>
                <div class="time-right">
                    <div id="gotoWrapper">
                        <button id="gotoToggle">Go to ‚ñæ</button>
                        <div id="gotoPanel" aria-hidden="true">
                            <div class="group-grid" id="groupGrid">
                                <!-- groups injected here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Time + transliteration toggle + Go to -->
            <div class="time-row">
                <div class="time-left">
                    	
                </div>

            </div>
        </div>
        <!-- native audio element -->
        <audio id="audio" preload="auto"></audio>
        <!-- subtitles (IMPORTANT: container's sizing & padding kept EXACTLY as original) -->
<div id="currentInfo" style="font-size: 1.3rem;">Dashakam ‚Äî Verse ‚Äî</div>

                
        <div id="subtitleContainer">
            <div id="overlayImage"></div>
            <!-- NEW foreground overlay -->
            <div id="verse"></div>
            <div id="splitWords"></div>
            <div id="meaning"></div>
        </div>
        <!-- full original script preserved with small additions for theme toggling only.
            All original IDs, event handlers and behavior are kept intact. -->
        <script>
            /* ===========================
               Original app script (kept functionally the same)
               plus theme-mode toggle handling at the end.
               =========================== */
            document.addEventListener('DOMContentLoaded', () => {
              /*** DOM references ***/
              const audio = document.getElementById('audio');
              const playPauseBtn = document.getElementById('playPauseBtn');
              const minus10DashakamBtn = document.getElementById('minus10DashakamBtn');
              const plus10DashakamBtn  = document.getElementById('plus10DashakamBtn');
              const prevDashakamBtn = document.getElementById('prevDashakamBtn');
              const nextDashakamBtn = document.getElementById('nextDashakamBtn');
              const prevVerseBtn = document.getElementById('prevVerseBtn');
              const nextVerseBtn = document.getElementById('nextVerseBtn');
              const repeatVerseBtn = document.getElementById('repeatVerseBtn');
              const repeatDashakamBtn = document.getElementById('repeatDashakamBtn');
              const speedBtn = document.getElementById('speedBtn');
              const muteBtn = document.getElementById('muteBtn');
              const volumeSlider = document.getElementById('volumeSlider');
              const volumeIcon = muteBtn.querySelector('i');

              // Set default volume to 25%
              audio.volume = 0.25;
              volumeSlider.value = audio.volume * 100;
              const timeDisplay = document.getElementById('timeDisplay');
              const verseDiv = document.getElementById('verse');
              const splitWordsDiv = document.getElementById('splitWords');
              const meaningDiv = document.getElementById('meaning');
              const gotoToggle = document.getElementById('gotoToggle');
              const gotoPanel = document.getElementById('gotoPanel');
              const groupGrid = document.getElementById('groupGrid');
              const themeDots = document.getElementById('themeDots');
              const translitToggle = document.getElementById('translitToggle');
            // ------------------------------
            //  Text elements that need dynamic color updates
            // ------------------------------
            const textElements = [
              verseDiv,
              splitWordsDiv,
              meaningDiv,
              timeDisplay,
              playPauseBtn,
              prevVerseBtn,
              nextVerseBtn,
              prevDashakamBtn,
              nextDashakamBtn,
              repeatVerseBtn,
              repeatDashakamBtn,
              speedBtn,
              muteBtn,
              gotoToggle,
              ...document.querySelectorAll('.group-select')
            ];
            
              /*** State ***/
              const totalDashakams = 100;
              const estimatedDashakamDuration = 300;
              let cues = [];
              let currentCueIndex = -1;
              let currentDashakam = 1;
              let showTranslit = false;
              let speedOptions = [1, 1.25, 1.5, 2];
              let speedIndex = 0;
              let speedTimeout = null;
              let dashakamTitles = [];  // will hold all titles from JSON
              // seek state flags
              let isSeeking = false;
              let lastSeekTarget = 0;
            
              /*** Helpers ***/
              const nl2br = s => (s ? s.replace(/\n/g, '<br>') : '');
              const isAscii = s => /^[\x00-\x7F\s.,'"()\-:;!?‚Äî‚Äì‚Ä¶0-9]+$/.test(s);
            
              const DEBUG = false;
              const trace = (msg, data = {}) => { if (DEBUG) console.log(`[TRACE] ${msg}`, data); };
            
              // restore repeat settings from localStorage (if any)
              let repeatVerse = localStorage.getItem('repeatVerse') === 'true';
              let repeatDashakam = localStorage.getItem('repeatDashakam') === 'true';
              repeatVerseBtn.classList.toggle('active', repeatVerse);
              repeatDashakamBtn.classList.toggle('active', repeatDashakam);
            

              // ========== ABOUT MODAL ==========
              const aboutBtn = document.getElementById("aboutBtn");
              const aboutModal = document.getElementById("aboutModal");
              const aboutClose = document.getElementById("aboutClose");

              aboutBtn.onclick = () => {
                aboutModal.style.display = "flex";
              };

              aboutClose.onclick = () => {
                aboutModal.style.display = "none";
              };

              aboutModal.onclick = (e) => {
                if (e.target === aboutModal) {
                  aboutModal.style.display = "none";
                }
              };


              // ========== CREDITS MODAL ==========
              const creditsBtn = document.getElementById("creditsBtn");
              const creditsModal = document.getElementById("creditsModal");
              const creditsClose = document.getElementById("creditsClose");

              creditsBtn.onclick = () => {
                creditsModal.style.display = "flex";
              };

              creditsClose.onclick = () => {
                creditsModal.style.display = "none";
              };

              creditsModal.onclick = (e) => {
                if (e.target === creditsModal) {
                  creditsModal.style.display = "none";
                }
              };



              function timeToSeconds(t) {
                if (!t) return 0;
                const p = t.split(':').map(Number);
                if (p.length === 3) return p[0] * 3600 + p[1] * 60 + p[2];
                if (p.length === 2) return p[0] * 60 + p[1];
                return p[0] || 0;
              }
            
              // display current Dashakam/verse (if a UI element exists)
            function updateCurrentInfo() {
              const infoEl = document.getElementById("currentInfo");
              if (!infoEl) return;
            
              const verseNum = (currentCueIndex === -1) ? '-' : (currentCueIndex + 1);
              const title = getDashakamTitle(currentDashakam);
            
              // Show with title included
              // Example: Dashakam 001 ‚Äì Form and Glory of the Lord ‚Äî Verse 3
              infoEl.textContent = `Dashakam ${String(currentDashakam).padStart(3, '0')} ‚Äî ${title} ‚Äî Verse ${verseNum}`;
            }
            
/*** Cue parsing ***/
function parseCueText(text) {
  if (!text) return emptyResult();

  // Remove only "Translation failed" lines
  const cleaned = text
    .split(/\r?\n/)
    .map(x => x.trim())
    .filter(Boolean)
    .filter(x => !x.includes("Translation failed"))
    .join("\n");

  return {
    verseDev: cleaned,
    splitDev: "",
    verseMalayalam: cleaned,
    splitMalayalam: "",
    verseTamil: cleaned,
    splitTamil: "",
    verseEnglish: cleaned,
    splitEnglish: "",
    verseTrans: "",
    splitTrans: "",
    meaning: ""
  };
}

function emptyResult() {
  return {
    verseDev: "",
    splitDev: "",
    verseMalayalam: "",
    splitMalayalam: "",
    verseTamil: "",
    splitTamil: "",
    verseEnglish: "",
    splitEnglish: "",
    verseTrans: "",
    splitTrans: "",
    meaning: ""
  };
}







            
              /*** VTT loader ***/
              async function loadVTT(url) {
                try {
                  const txt = await fetch(url).then(r => (r.ok ? r.text() : ''));
                  if (!txt) {
                    console.warn('‚ö†Ô∏è Empty or missing VTT:', url);
                    return [];
                  }
                  const lines = txt.split(/\r?\n/);
                  const out = [];
                  for (let i = 0; i < lines.length; i++) {
                    if (lines[i].includes('-->')) {
                      const [start, end] = lines[i].split('-->');
                      const textLines = [];
                      i++;
                      while (i < lines.length && lines[i].trim() !== '') {
                        textLines.push(lines[i]);
                        i++;
                      }
                      out.push({
                        start: (start || '').trim(),
                        end: (end || '').trim(),
                        text: textLines.join('\n')
                      });
                    }
                  }
                  console.log(`‚úÖ Loaded ${out.length} cues from ${url}`);
                  return out;
                } catch (e) {
                  console.error('‚ùå loadVTT failed:', e);
                  return [];
                }
              }
            function showSubtitleOverlay(show = true) {
              const container = document.getElementById('subtitleContainer');
              if (!container) return;
            
              if (show) {
                container.classList.add('show-overlay');
              } else {
                container.classList.remove('show-overlay');
              }
            }
            /*** Subtitle update (UI only) ***/
            function updateSubtitle(index) {
  if (!cues || index < 0 || index >= cues.length) return;
  currentCueIndex = index;

  const parsed = parseCueText(cues[index].text);

  // ------------------------------------------------------------------
  // DETERMINE ACTIVE LANGUAGE EXACTLY
  // ------------------------------------------------------------------
  let verseRaw = "";
  let splitRaw = "";
  let meaningRaw = parsed.meaning || "";

  if (!showTranslit) {
    // ---------------- DEVANAGARI MODE ----------------
    verseRaw = parsed.verseDev || "";
    splitRaw = parsed.splitDev || "";
  } 
  else if (showTranslit && translitState === "english") {
    // ---------------- ENGLISH MODE ----------------
    verseRaw = parsed.verseEnglish || parsed.verseTrans || "";
    splitRaw = parsed.splitEnglish || parsed.splitTrans || "";
  } 
else if (showTranslit && translitState === "malayalam") {
    // ---------------- MALAYALAM MODE ----------------
    verseRaw = parsed.verseMalayalam || "";
    splitRaw = parsed.splitMalayalam || "";
}
else if (showTranslit && translitState === "tamil") {
    // ---------------- TAMIL MODE ----------------
    verseRaw = parsed.verseTamil || "";
    splitRaw = parsed.splitTamil || "";
}

verseRaw = verseRaw || "";
splitRaw = splitRaw || "";
meaningRaw = meaningRaw || "";



  // ------------------------------------------------------------------
  // Apply highlighting ONLY to verse
  // ------------------------------------------------------------------
const lang = !showTranslit
    ? "devanagari"
    : translitState === "english"
      ? "english"
      : translitState === "malayalam"
        ? "malayalam"
        : translitState === "tamil"
          ? "tamil"
          : "english"; // fallback

function autoDetectScript(txt) {
  txt = txt || "";

  // Devanagari
  if (/[‡§Ñ-‡•ø]/.test(txt)) return "devanagari";

  // Malayalam
  if (/[‡¥Ö-‡µø]/.test(txt)) return "malayalam";

  // Tamil (vowels, consonants, aytam, and combining marks)
  if (/[‡ÆÖ-‡Æî‡ÆÉ‡Æï-‡Æπ]/.test(txt)) return "tamil";

  // Default to English/translit
  return "english";
}


// Auto-detect actual script in this cue
const detectedLang = autoDetectScript(verseRaw);

// Override UI-selected language ONLY if the text belongs to another script
const langForHighlight = detectedLang;

// Apply highlight
// With the new all-scripts version:
const verseText = highlightMahapraanasAllScripts(verseRaw);
  const splitText = String(splitRaw).normalize("NFC");

  // ------------------------------------------------------------------
  // RENDER
  // ------------------------------------------------------------------
  verseDiv.innerHTML = nl2br(verseText);
  splitWordsDiv.innerHTML = nl2br(splitText);
  meaningDiv.innerHTML = nl2br(meaningRaw);

  showSubtitleOverlay(true);

  // ------------------------------------------------------------------
  // Update dashakam header
  // ------------------------------------------------------------------
  const infoEl = document.getElementById("currentInfo");
  if (infoEl) {
    const verseNum = currentCueIndex + 1;
    let title = "";
    if (dashakamTitles?.length) {
      const d = dashakamTitles.find(x => x.number === currentDashakam);
      if (d) title = d.english_title || "";
    }
    infoEl.textContent =
      `Dashakam ${String(currentDashakam).padStart(3, "0")}` +
      (title ? ` ‚Äî ${title}` : "") +
      ` ‚Äî Verse ${verseNum}`;
  }
}

            
            // ---------------- Robust MahƒÅprƒÅ·πáa highlighting ---------------- 
            
// Devanagari range: 0900‚Äì097F
const devanagariRegex = /[\u0900-\u097F]+/g;

// Malayalam range: 0D00‚Äì0D7F
const malayalamRegex = /[\u0D00-\u0D7F]+/g;

// Tamil range: 0B80‚Äì0BFF
const tamilRegex = /[\u0B80-\u0BFF]+/g;
            
            function highlightMahapraana(text, script = 'devanagari') {
              if (!text) return '';
              text = String(text).normalize('NFC');
            
              // helper to sort patterns longest-first to avoid partial match issues
              const sortByLengthDesc = arr => arr.sort((a,b) => b.length - a.length);
            
              if (script === 'devanagari') {
                const devanagariPatterns = sortByLengthDesc([
                  // basic aspirates
                  '‡§ñ','‡§ò','‡§õ','‡§ù','‡§†','‡§¢','‡§•','‡§ß','‡§´','‡§≠',
                  // frequent aspirated clusters / conjuncts
                  '‡§∏‡•ç‡§•','‡§∏‡•ç‡§•‡§ø','‡§∏‡•ç‡§´','‡§∏‡•ç‡§´‡•Å','‡§¶‡•ç‡§≠','‡§¶‡•ç‡§ò','‡§¶‡•ç‡§ß','‡§£‡•ç‡§†','‡§ö‡•ç‡§õ','‡§ö‡•ç‡§õ‡§æ',
                  '‡§∞‡•ç‡§≠','‡§¨‡•ç‡§ß','‡§¨‡•ç‡§ß‡•á','‡§∞‡•ç‡§•','‡§ó‡•ç‡§ß','‡§®‡•ç‡§ß','‡§∞‡•ç‡§•‡•ç‡§Ø','‡§∞‡•ç‡§•‡§æ'
                ]);
                const re = new RegExp(devanagariPatterns.join('|'), 'g');
                return text.replace(re, m => `<span class="mahapraana">${m}</span>`);
              }
            
              if (script === 'malayalam') {
                const malPatterns = sortByLengthDesc([
                  // basic aspirates
                  '‡¥ñ','‡¥ò','‡¥õ','‡¥ù','‡¥†','‡¥¢','‡¥•','‡¥ß','‡¥´','‡¥≠',
                  // variants / clusters
                  '‡¥∏‡µç‡¥•','‡¥∏‡µç‡¥•‡¥ø','‡¥∏‡µç‡¥´','‡¥∏‡µç‡¥´‡µÅ','‡¥¶‡µç‡¥≠','‡¥¶‡µç‡¥ò','‡¥¶‡µç‡¥ß','‡¥£‡µç‡¥†',
                  // aspirated CH forms
                  '‡¥õ‡¥æ','‡¥õ‡µç','‡¥∏‡µç‡¥µ‡¥õ','‡¥õ‡µç‡¥ö','‡¥õ‡µç‡¥§',
                  '‡µº‡¥≠','‡¥¨‡µç‡¥ß','‡¥¨‡µç‡¥ß‡µÜ','‡µº‡¥•','‡¥ó‡µç‡¥ß','‡¥®‡µç‡¥ß','‡¥∞‡µç‚Äç‡¥§‡µç‡¥•‡µç‡¥Ø','‡¥∞‡µç‚Äç‡¥§‡µç‡¥•‡¥æ'
                ]);
                const re = new RegExp(malPatterns.join('|'), 'g');
                return text.replace(re, m => `<span class="mahapraana">${m}</span>`);
              }
            if (script === 'tamil') {
    const tamPatterns = sortByLengthDesc([
  '‡Æï‡Øç‡Æπ','‡Æï‡Øç‡Æπ‡Ææ','‡Æö‡Øç‡Æπ','‡Æú‡Øç‡Æπ','‡Æü‡Øç‡Æπ','‡Æü‡Øç‡Æπ‡Ææ','‡Æ§‡Øç‡Æπ','‡Æ§‡Øç‡Æπ‡Ææ','‡Æ™‡Øç‡Æπ','‡Æ™‡Øç‡Æπ‡Ææ',
  '‡Æ∏‡Øç‡Æ§‡Øç‡Æπ','‡Æ∏‡Øç‡Æ§‡Øç‡Æπ‡Æø','‡Æ∏‡Øç‡Æ™‡Øç‡Æπ','‡Æ∏‡Øç‡Æ™‡Øç‡Æπ‡ØÅ','‡Æ®‡Øç‡Æ§‡Øç‡Æπ','‡Æ©‡Øç‡Æ§‡Øç‡Æπ','‡Æ∞‡Øç‡Æ§‡Øç‡Æπ','‡Æ£‡Øç‡Æü‡Øç‡Æπ',
  '‡Æö‡Øç‡Æπ‡Ææ','‡Æö‡Øç‡Æπ‡Øç','‡Æ∏‡Øç‡Æµ‡Æõ','‡Æö‡Øç‡Æπ‡Øç‡Æö','‡Æö‡Øç‡Æπ‡Øç‡Æ§',
  '‡Æ∞‡Øç‡Æπ','‡Æ™‡Øç‡Æ§‡Øç‡Æπ','‡Æ™‡Øç‡Æ§‡Øç‡Æπ‡Øá','‡Æ∞‡Øç‡Æ§‡Øç‡Æπ','‡Æï‡Øç‡Æ§‡Øç‡Æπ','‡Æ®‡Øç‡Æ§‡Øç‡Æπ','‡Æ∞‡Øç‡Æ§‡Øç‡Æπ‡Øç‡ÆØ','‡Æ∞‡Øç‡Æ§‡Øç‡Æπ‡Ææ'
]);

    const re = new RegExp(tamPatterns.join('|'), 'g');
    return text.replace(re, m => `<span class="mahapraana">${m}</span>`);
}

              if (script === 'english') {
                const engPatterns = sortByLengthDesc([
                  'kh','gh','chh','jh','·π≠h','·∏çh','th','dh','ph','bh',
                  'stha','sthi','sph','sphu','dbh','ddh','·πá·π≠h',
                  'cch','cchƒÅ','svacch','rbh','bdh','bdhe','rth','gdh','ndh','rthya','rthƒÅ'
                ]);
                const re = new RegExp(engPatterns.join('|'), 'gi');
                return text.replace(re, m => `<span class="mahapraana">${m}</span>`);
              }
            
              return text;
            }
            
            
  function highlightMahapraanasAllScripts(text) {
  if (!text) return '';
  text = String(text).normalize('NFC');

  const sortByLengthDesc = arr => arr.sort((a, b) => b.length - a.length);

  // ---------------- Devanagari ----------------
  const devanagariPatterns = sortByLengthDesc([
    '‡§ñ','‡§ò','‡§õ','‡§ù','‡§†','‡§¢','‡§•','‡§ß','‡§´','‡§≠',
    '‡§∏‡•ç‡§•','‡§∏‡•ç‡§•‡§ø','‡§∏‡•ç‡§´','‡§∏‡•ç‡§´‡•Å','‡§¶‡•ç‡§≠','‡§¶‡•ç‡§ò','‡§¶‡•ç‡§ß','‡§£‡•ç‡§†','‡§ö‡•ç‡§õ','‡§ö‡•ç‡§õ‡§æ',
    '‡§∞‡•ç‡§≠','‡§¨‡•ç‡§ß','‡§¨‡•ç‡§ß‡•á','‡§∞‡•ç‡§•','‡§ó‡•ç‡§ß','‡§®‡•ç‡§ß','‡§∞‡•ç‡§•‡•ç‡§Ø','‡§∞‡•ç‡§•‡§æ'
  ]);
  const devanagariRegex = new RegExp(devanagariPatterns.join('|'), 'g');
  text = text.replace(devanagariRegex, m => `<span class="mahapraana">${m}</span>`);

  // ---------------- Malayalam ----------------
  const malPatterns = sortByLengthDesc([
    '‡¥ñ','‡¥ò','‡¥õ','‡¥ù','‡¥†','‡¥¢','‡¥•','‡¥ß','‡¥´','‡¥≠',
    '‡¥∏‡µç‡¥•','‡¥∏‡µç‡¥•‡¥ø','‡¥∏‡µç‡¥´','‡¥∏‡µç‡¥´‡µÅ','‡¥¶‡µç‡¥≠','‡¥¶‡µç‡¥ò','‡¥¶‡µç‡¥ß','‡¥£‡µç‡¥†',
    '‡¥õ‡¥æ','‡¥õ‡µç','‡¥∏‡µç‡¥µ‡¥õ','‡¥õ‡µç‡¥ö','‡¥õ‡µç‡¥§',
    '‡µº‡¥≠','‡¥¨‡µç‡¥ß','‡¥¨‡µç‡¥ß‡µÜ','‡µº‡¥•','‡¥ó‡µç‡¥ß','‡¥®‡µç‡¥ß','‡¥∞‡µç‚Äç‡¥§‡µç‡¥•‡µç‡¥Ø','‡¥∞‡µç‚Äç‡¥§‡µç‡¥•‡¥æ'
  ]);
  const malRegex = new RegExp(malPatterns.join('|'), 'g');
  text = text.replace(malRegex, m => `<span class="mahapraana">${m}</span>`);

  // ---------------- Tamil ----------------
  const tamPatterns = sortByLengthDesc([
  '‡Æï‡Øç‡Æπ','‡Æï‡Øç‡Æπ‡Ææ','‡Æö‡Øç‡Æπ','‡Æú‡Øç‡Æπ','‡Æü‡Øç‡Æπ','‡Æü‡Øç‡Æπ‡Ææ','‡Æ§‡Øç‡Æπ','‡Æ§‡Øç‡Æπ‡Ææ','‡Æ™‡Øç‡Æπ','‡Æ™‡Øç‡Æπ‡Ææ',
  '‡Æ∏‡Øç‡Æ§‡Øç‡Æπ','‡Æ∏‡Øç‡Æ§‡Øç‡Æπ‡Æø','‡Æ∏‡Øç‡Æ™‡Øç‡Æπ','‡Æ∏‡Øç‡Æ™‡Øç‡Æπ‡ØÅ','‡Æ®‡Øç‡Æ§‡Øç‡Æπ','‡Æ©‡Øç‡Æ§‡Øç‡Æπ','‡Æ∞‡Øç‡Æ§‡Øç‡Æπ','‡Æ£‡Øç‡Æü‡Øç‡Æπ',
  '‡Æö‡Øç‡Æπ‡Ææ','‡Æö‡Øç‡Æπ‡Øç','‡Æ∏‡Øç‡Æµ‡Æõ','‡Æö‡Øç‡Æπ‡Øç‡Æö','‡Æö‡Øç‡Æπ‡Øç‡Æ§',
  '‡Æ∞‡Øç‡Æπ','‡Æ™‡Øç‡Æ§‡Øç‡Æπ','‡Æ™‡Øç‡Æ§‡Øç‡Æπ‡Øá','‡Æ∞‡Øç‡Æ§‡Øç‡Æπ','‡Æï‡Øç‡Æ§‡Øç‡Æπ','‡Æ®‡Øç‡Æ§‡Øç‡Æπ','‡Æ∞‡Øç‡Æ§‡Øç‡Æπ‡Øç‡ÆØ','‡Æ∞‡Øç‡Æ§‡Øç‡Æπ‡Ææ'
]);
  const tamRegex = new RegExp(tamPatterns.join('|'), 'g');
  text = text.replace(tamRegex, m => `<span class="mahapraana">${m}</span>`);

  // ---------------- English transliteration ----------------
  const engPatterns = sortByLengthDesc([
    'kh','gh','chh','jh','·π≠h','·∏çh','th','dh','ph','bh',
    'stha','sthi','sph','sphu','dbh','ddh','·πá·π≠h',
    'cch','cchƒÅ','svacch','rbh','bdh','bdhe','rth','gdh','ndh','rthya','rthƒÅ'
  ]);
  const engRegex = new RegExp(engPatterns.join('|'), 'gi');
  text = text.replace(engRegex, m => `<span class="mahapraana">${m}</span>`);

  return text;
}


            
              /*** Minimal group grid + highlight (to avoid undefined errors) ***/
              function buildGroupGrid() {
                if (!groupGrid) return;
                groupGrid.innerHTML = '';
                for (let g = 0; g < 10; g++) {
                  const start = g * 10 + 1, end = start + 9;
                  const wrapper = document.createElement('div');
                  wrapper.style.display = 'flex';
                  wrapper.style.flexDirection = 'column';
                  wrapper.style.gap = '6px';
                  wrapper.style.alignItems = 'center';
                  const title = document.createElement('div');
                  title.textContent = `${start}‚Äì${end}`;
                  title.style.fontWeight = '700';
                  wrapper.appendChild(title);
                  const mini = document.createElement('div');
                  mini.style.display = 'flex';
                  mini.style.flexWrap = 'wrap';
                  mini.style.gap = '6px';
                  mini.style.justifyContent = 'center';
                  for (let i = start; i <= end; i++) {
                    const btn = document.createElement('button');
                    btn.className = 'group-select';
                    btn.textContent = i;
                    btn.dataset.val = i.toString().padStart(3, '0');
                    btn.addEventListener('click', ev => {
                      loadDashakam(ev.currentTarget.dataset.val);
                      openGoto(false);
                    });
                    mini.appendChild(btn);
                  }
                  wrapper.appendChild(mini);
                  groupGrid.appendChild(wrapper);
                }
              }
              function highlightGoTo() {
                if (!groupGrid) return;
                groupGrid.querySelectorAll('.group-select').forEach(b => (b.style.background = 'transparent'));
                const sel = groupGrid.querySelector(`.group-select[data-val="${String(currentDashakam).padStart(3,'0')}"]`);
                if (sel) sel.style.background = getComputedStyle(document.documentElement).getPropertyValue('--accent-soft') || '#a4d4a6';
              }
            
            // 1Ô∏è‚É£ Load the titles JSON once at startup
            async function loadDashakamTitles() {
              try {
                const res = await fetch("title_and_meter.json");
                dashakamTitles = await res.json();
                console.log("Loaded Dashakam titles:", dashakamTitles.length);
              } catch (err) {
                console.error("Failed to load titles:", err);
                dashakamTitles = [];
              }
            }
            
            // 2Ô∏è‚É£ Function to get the English title for a given dashakam number
            function getDashakamTitle(num) {
              const entry = dashakamTitles.find(t => t.number === num);
              return entry ? entry.english_title : "";
            }
            
              /*** Load Dashakam (clean version) ***/
              async function loadDashakam(val, autoPlay = false) {
    console.log("üîÑ Loading Dashakam:", val);

    currentDashakam = parseInt(val, 10);
    audio.pause();
    audio.src = `audio/Narayaneeyam_D${val}.mp3`;
    audio.preload = "auto";
    audio.load();

    // restore volume/mute after loading new audio
    audio.volume = volumeSlider.value / 100;
    if (audio.volume > 0) audio.muted = false;
    updateVolumeIcon();

    // wait for metadata
    await new Promise(resolve => {
        const onMeta = () => { audio.removeEventListener('loadedmetadata', onMeta); resolve(); };
        audio.addEventListener('loadedmetadata', onMeta);
        setTimeout(resolve, 2000);
    });

    // load subtitles
    cues = await loadVTT(`vtt_time_devanagari_english/Narayaneeyam_D${val}.vtt`);
    currentCueIndex = -1;
    verseDiv.innerHTML = splitWordsDiv.innerHTML = meaningDiv.innerHTML = "";

    if (cues.length > 0) {
        await jumpToCue(0, false);
        updateSubtitle(0);
    }

    highlightGoTo();
    playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';

    if (autoPlay) {
        try { await audio.play(); playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>'; }
        catch(e){ console.warn("Autoplay failed:", e); }
    }

    console.log(`‚úÖ Dashakam ${val} ready with ${cues.length} verses`);
}

            
              /*** Jump to cue ‚Äî robust seek with retries and clear timeupdate suppression ***/
              async function jumpToCue(index, keepPlaying = true) {
                if (!cues || !cues[index]) return;
                const cue = cues[index];
                const target = timeToSeconds(cue.start);
                console.log('jumpToCue: moving to cue', index, 'time=', target.toFixed(3));
            
                isSeeking = true;
                lastSeekTarget = target;
            
                // ensure metadata/canplay
                if (audio.readyState < 1) {
                  await new Promise(resolve => {
                    audio.addEventListener('loadedmetadata', () => resolve(), { once: true });
                    // small timeout fallback
                    setTimeout(() => resolve(), 800);
                  });
                }
            
                const maxAttempts = 5;
                let attempt = 0;
                let success = false;
            
                while (attempt < maxAttempts && !success) {
                  attempt++;
                  // perform seek
                  try {
                    audio.currentTime = target;
                  } catch (e) {
                    // some browsers may throw if not ready; ignore and continue
                    console.warn('jumpToCue: set currentTime error', e);
                  }
            
                  // wait for seeked event (or timeout)
                  await new Promise(resolve => {
                    let resolved = false;
                    const onSeeked = () => {
                      if (resolved) return;
                      resolved = true;
                      audio.removeEventListener('seeked', onSeeked);
                      resolve();
                    };
                    audio.addEventListener('seeked', onSeeked, { once: true });
                    // fallback timeout if seeked doesn't fire quickly
                    setTimeout(() => {
                      if (!resolved) {
                        resolved = true;
                        audio.removeEventListener('seeked', onSeeked);
                        resolve();
                      }
                    }, 400);
                  });
            
                  // check how close we are to target
                  const diff = Math.abs(audio.currentTime - target);
                  console.log(`jumpToCue: attempt #${attempt} currentTime=${audio.currentTime.toFixed(3)} diff=${diff.toFixed(3)}`);
                  if (diff <= 0.35) {
                    success = true;
                    break;
                  } else {
                    // small delay before retrying
                    await new Promise(r => setTimeout(r, 120));
                  }
                }
            
            
            // finalize UI state regardless of absolute success
currentCueIndex = index;
updateSubtitle(index);

            
            
                // resume play if requested
                if (keepPlaying) {
                  try {
                    await audio.play();
                  } catch (e) {
                    console.warn('jumpToCue: play failed after seek', e);
                  }
                }
            
                // allow timeupdate to resume mapping cues
                setTimeout(() => {
                  isSeeking = false;
                  // set lastSeekTarget a small delay so timeupdate ignores tiny immediate jumps
                  setTimeout(() => { lastSeekTarget = 0; }, 300);
                }, 250);
            
                console.log('jumpToCue: finished (success=' + success + ') currentTime=' + audio.currentTime.toFixed(3));
              }
            
              /*** Cue index helper (map time to cue) ***/
              function getCueIndexAtTime(nowSec = audio.currentTime) {
                if (!cues || cues.length === 0) return -1;
                for (let i = 0; i < cues.length; i++) {
                  const s = timeToSeconds(cues[i].start);
                  const e = timeToSeconds(cues[i].end);
                  if (nowSec >= s && nowSec < e) return i;
                }
                const idx = cues.findIndex(c => timeToSeconds(c.start) > nowSec);
                return idx > 0 ? idx - 1 : 0;
              }
            function refreshSubtitleOverlay() {
    const container = document.getElementById('subtitleContainer');
    if (!container) return;
    container.classList.remove('show-overlay');
    setTimeout(() => container.classList.add('show-overlay'), 50);
}
              /*** SINGLE Timeupdate Handler (fixed repeat + next dashakam) ***/
              audio.addEventListener("timeupdate", async () => {
                if (!cues || isSeeking) return;
                const now = audio.currentTime;
            
                // Repeat verse handling
                if (repeatVerse && currentCueIndex >= 0 && currentCueIndex < cues.length) {
                  const cue = cues[currentCueIndex];
                  const cueStart = timeToSeconds(cue.start);
                  const cueEnd = timeToSeconds(cue.end);
                  if (now >= cueEnd - 0.15) {
                    console.log(`üîÅ Repeating verse ${currentCueIndex + 1}`);
                    audio.currentTime = cueStart;
                    return;
                  }
                }
            
                // Normal cue switching
                const idx = getCueIndexAtTime(now);
                if (idx !== currentCueIndex) {
                  currentCueIndex = idx;
                  updateSubtitle(idx);
                  updateCurrentInfo();
                }
            
                // End of dashakam ‚Üí load next
if (
  cues.length > 0 &&
  currentCueIndex === cues.length - 1 &&
  now >= timeToSeconds(cues[cues.length - 1].end) - 0.25
) {
    if (repeatDashakam) {
        console.log("üîÅ Repeating Dashakam");
        await jumpToCue(0, true);
        return;
    }
    if (currentDashakam < totalDashakams) {
    const nextD = String(currentDashakam + 1).padStart(3, '0');
    console.log(`‚û°Ô∏è Moving to next Dashakam ${nextD}`);
    // load next dashakam audio
await loadDashakam(nextD, false);

// NOW load transliteration-aware subtitles (IMPORTANT!)
await loadTranslitCues(nextD);    

// jump to first cue
if (cues.length > 0) {
    await jumpToCue(0, true);
}

}
 else {
        console.log("üõë End of final Dashakam");
        audio.pause();
    }
}

              });
            
              /*** Prev / Next Verse handlers ***/
             prevVerseBtn.addEventListener('click', async () => {
    if (!cues || cues.length === 0) return;

    let idx = currentCueIndex !== -1 ? currentCueIndex : getCueIndexAtTime();
    console.log(`‚¨ÖÔ∏è prevVerse clicked, currentCueIndex=${currentCueIndex}, computedIdx=${idx}`);

    // Move to previous cue if possible
    if (idx > 0) {
        await jumpToCue(idx - 1);
        return;
    }

    // Move to previous Dashakam if available
    if (currentDashakam > 1) {
        const prevD = String(currentDashakam - 1).padStart(3, '0');
        const wasPlaying = !audio.paused && !audio.ended;
        console.log(`‚¨ÖÔ∏è prevVerse: start of dashakam ${currentDashakam}, loading previous ${prevD}`);

        // Load previous Dashakam cues fully (supports Malayalam)
        await loadTranslitCues(prevD);
        currentDashakam -= 1;

        if (cues.length > 0) {
            await jumpToCue(cues.length - 1, wasPlaying);
        }
    }
    // Repeat Dashakam if enabled
    else if (repeatDashakam && cues.length > 0) {
        await jumpToCue(cues.length - 1);
    }
});


            
              nextVerseBtn.addEventListener('click', async () => {
    trace('nextVerseBtn.click', { currentCueIndex, audioTime: audio.currentTime.toFixed(3) });

    if (!cues || cues.length === 0) return;

    let idx = currentCueIndex !== -1 ? currentCueIndex : getCueIndexAtTime();
    console.log(`‚û°Ô∏è nextVerse clicked, currentCueIndex=${currentCueIndex}, computedIdx=${idx}`);

    // Move to next cue within the current Dashakam
    if (idx < cues.length - 1) {
        // Wait until audio can play if not ready
        if (audio.readyState < 2) {
            await new Promise(resolve => {
                const onCan = () => { audio.removeEventListener('canplay', onCan); resolve(); };
                audio.addEventListener('canplay', onCan);
                setTimeout(resolve, 700); // fallback
            });
        }

        console.log(`‚è≠Ô∏è nextVerse: moving to next cue ${idx + 1}`);
        await jumpToCue(idx + 1, true);
        return;
    }

    // End of current Dashakam ‚Äî move to next Dashakam
    if (currentDashakam < totalDashakams) {
        const nextD = String(currentDashakam + 1).padStart(3, '0');
        const wasPlaying = !audio.paused && !audio.ended;
        console.log(`‚û°Ô∏è nextVerse: end of dashakam ${currentDashakam}, loading ${nextD}`);

        // Load next Dashakam cues fully (supports Malayalam)
        await loadTranslitCues(nextD);
        currentDashakam += 1;

        if (cues.length > 0) {
            await jumpToCue(0, wasPlaying);
        }
    }
    // Repeat Dashakam if enabled
    else if (repeatDashakam && cues.length > 0) {
        console.log(`üîÅ Repeating Dashakam`);
        await jumpToCue(0, true);
    }
});


            
/*** DASHAMAK NAVIGATION BUTTONS ***/
async function goToDashakam(targetDashakam) {
    if (targetDashakam < 1 || targetDashakam > totalDashakams) return;

    const dashStr = String(targetDashakam).padStart(3, '0');
    console.log(`‚û°Ô∏è Loading Dashakam ${dashStr}`);

    const wasPlaying = !audio.paused && !audio.ended;
    currentDashakam = targetDashakam;

    // Load the audio
    audio.pause();
    audio.src = `audio/Narayaneeyam_D${dashStr}.mp3`;
    audio.load();

    // Restore volume/mute
    audio.volume = volumeSlider.value / 100;
    if (audio.volume > 0) audio.muted = false;
    updateVolumeIcon();

    // Wait for audio metadata to load
    await new Promise(resolve => {
        const onMeta = () => { audio.removeEventListener('loadedmetadata', onMeta); resolve(); };
        audio.addEventListener('loadedmetadata', onMeta);
        setTimeout(resolve, 2000); // fallback
    });

    // Load cues for current transliteration
    await loadTranslitCues(dashStr);

    currentCueIndex = -1;
    if (cues.length > 0) {
        await jumpToCue(0, wasPlaying);
    }

    highlightGoTo();
}

// Previous Dashakam
prevDashakamBtn.addEventListener('click', async () => {
    if (currentDashakam > 1) {
        await goToDashakam(currentDashakam - 1);
    }
});

// Next Dashakam
nextDashakamBtn.addEventListener('click', async () => {
    if (currentDashakam < totalDashakams) {
        await goToDashakam(currentDashakam + 1);
    }
});

// Jump back 10 Dashakams
minus10DashakamBtn.addEventListener('click', async () => {
    if (currentDashakam > 1) {
        const target = Math.max(1, currentDashakam - 10);
        await goToDashakam(target);
    }
});

// Jump forward 10 Dashakams
plus10DashakamBtn.addEventListener('click', async () => {
    if (currentDashakam < totalDashakams) {
        const target = Math.min(totalDashakams, currentDashakam + 10);
        await goToDashakam(target);
    }
});



            
              /*** Repeat toggles (mutually exclusive, with save + visual feedback) ***/
              repeatVerseBtn.addEventListener('click', () => {
                repeatVerse = !repeatVerse;
                if (repeatVerse) {
                  repeatDashakam = false; // disable dashakam repeat if verse repeat is active
                }
            
                repeatVerseBtn.classList.toggle('active', repeatVerse);
                repeatDashakamBtn.classList.toggle('active', repeatDashakam);
            
                // optional: save preference
                localStorage.setItem('repeatVerse', repeatVerse);
                localStorage.setItem('repeatDashakam', repeatDashakam);
            
                console.log(`üîÅ Repeat Verse: ${repeatVerse}`);
              });
            
              repeatDashakamBtn.addEventListener('click', () => {
                repeatDashakam = !repeatDashakam;
                if (repeatDashakam) {
                  repeatVerse = false; // disable verse repeat if dashakam repeat is active
                }
            
                repeatVerseBtn.classList.toggle('active', repeatVerse);
                repeatDashakamBtn.classList.toggle('active', repeatDashakam);
            
                // optional: save preference
                localStorage.setItem('repeatVerse', repeatVerse);
                localStorage.setItem('repeatDashakam', repeatDashakam);
            
                console.log(`‚ôæÔ∏è Repeat Dashakam: ${repeatDashakam}`);
              });
            
              /*** Play/pause icon management (also handled by audio events) ***/
              playPauseBtn.addEventListener('click', () => {
                if (audio.paused) audio.play().catch(()=>{});
                else audio.pause();
              });
              audio.addEventListener('play', () => playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>');
              audio.addEventListener('pause', () => playPauseBtn.innerHTML = '<i class="fas fa-play"></i>');
            
              /*** Speed / Mute ***/
              speedBtn.addEventListener('click', () => {
                speedIndex = (speedIndex + 1) % speedOptions.length;
                audio.playbackRate = speedOptions[speedIndex];
                const label = speedOptions[speedIndex] + '√ó';
                speedBtn.textContent = label;
                clearTimeout(speedTimeout);
                speedTimeout = setTimeout(() => { speedBtn.innerHTML = '<i class="fas fa-tachometer-alt"></i>'; }, 900);
              });
            

             // Update icon helper
              function updateVolumeIcon() {
                  if (audio.muted || audio.volume === 0) {
                      volumeIcon.className = 'fas fa-volume-mute';
                  } else if (audio.volume <= 0.5) {
                      volumeIcon.className = 'fas fa-volume-down';
                  } else {
                      volumeIcon.className = 'fas fa-volume-up';
                  }
              }

              // Click on the icon toggles mute
              volumeIcon.addEventListener('click', () => {
                  audio.muted = !audio.muted;
                  updateVolumeIcon();
              });

              // Slider input changes volume
              volumeSlider.addEventListener('input', () => {
                  audio.volume = volumeSlider.value / 100;
                  if (audio.volume > 0 && audio.muted) audio.muted = false;
                  updateVolumeIcon();
              });

              // Initialize
              updateVolumeIcon();
                      
              document.addEventListener('click', (e) => {
                const panel = document.getElementById('gotoPanel');
                const toggle = document.getElementById('gotoToggle');
                if (!panel || !toggle) return;
                if (!panel.contains(e.target) && !toggle.contains(e.target)) {
                  panel.style.display = 'none';
                  toggle.setAttribute('aria-expanded', 'false');
                }
              });
            
              /*** Time formatting / display (periodic refresh) ***/
              function formatTime(s) {
                if (!s || isNaN(s)) return '00:00';
                const m = Math.floor(s/60).toString().padStart(2,'0');
                const sec = Math.floor(s%60).toString().padStart(2,'0');
                return `${m}:${sec}`;
              }
            
              function updateTimeDisplay() {
                const elapsed = audio.currentTime || 0;
                const duration = (audio.duration && !isNaN(audio.duration)) ? audio.duration : estimatedDashakamDuration;
                const remaining = Math.max(0, duration - elapsed);
                timeDisplay.textContent = `Elapsed: ${formatTime(elapsed)} | Remaining: ${formatTime(remaining)}`;
              }
              setInterval(updateTimeDisplay, 1000);
              audio.addEventListener('timeupdate', updateTimeDisplay);
            
              /*** Go-to toggle simple handlers ***/
              let gotoOpen = false;
              function openGoto(open) { gotoOpen = open; if (gotoPanel) gotoPanel.style.display = open ? 'block' : 'none'; if (gotoToggle) gotoToggle.textContent = open ? 'Go to ‚ñ¥' : 'Go to ‚ñæ'; }
              if (gotoToggle) { gotoToggle.addEventListener('click', () => openGoto(!gotoOpen)); }
            
             // Only declare translitState once
            let translitState = 'devanagari';
                        
            async function loadTranslitCues(dashNum = null) {
    dashNum = dashNum || String(currentDashakam).padStart(3, '0');

    // your current mapping but WITHOUT the broken default
    let vttFolder;
    if (translitState === 'english') {
        vttFolder = 'vtt_time_devanagari_tamil';        // Tamil
    } else if (translitState === 'devanagari') {
        vttFolder = 'vtt_time_devanagari_english';      // English translit
    } else if (translitState === 'malayalam') {
        vttFolder = 'vtt_time__devanagari_malayalam';    // Malayalam
    } else {
        vttFolder = 'vtt_time_devanagari_tamil';        // fallback Tamil
    }

    cues = await loadVTT(`${vttFolder}/Narayaneeyam_D${dashNum}.vtt`);

    showTranslit = (translitState === 'english' || translitState === 'malayalam');

    const idx = currentCueIndex >= 0 ? currentCueIndex : 0;
    if (cues.length > 0) updateSubtitle(idx);

    return cues;
}
            
            // Initial load
            loadTranslitCues();
            
            // Button toggle
            if (translitToggle) {
                translitToggle.addEventListener('click', async () => {
                    translitState = translitState === 'english' ? 'devanagari' :
                                    translitState === 'devanagari' ? 'malayalam' : 'english';
            
                    translitToggle.textContent = translitState === 'english' ? 'Tamil' :
                                                 translitState === 'devanagari' ? 'English' : 'Malayalam';
            
                    await loadTranslitCues();
                });
            }
            
            
              /*** Audio ended handling: auto-next dashakam ***/
              audio.addEventListener('ended', async () => {
                console.log('üéµ audio ended event, currentCueIndex=', currentCueIndex);
            
                // Case 1Ô∏è‚É£ ‚Äî Repeat current verse if active
                if (repeatVerse && cues && currentCueIndex !== -1 && currentCueIndex < cues.length) {
                  console.log('üîÅ Repeating same verse', currentCueIndex);
                  await jumpToCue(currentCueIndex, true);
                  return;
                }
            
                // Case 2Ô∏è‚É£ ‚Äî Normal advance to next verse
                if (cues && currentCueIndex < cues.length - 1) {
                  console.log('‚û°Ô∏è Auto advancing to next verse');
                  await jumpToCue(currentCueIndex + 1, true);
                  return;
                }
            
                // Case 3Ô∏è‚É£ ‚Äî Reached end of dashakam
                if (cues && currentCueIndex >= cues.length - 1) {
                  if (repeatDashakam && cues.length > 0) {
                    console.log('üîÅ Repeating entire dashakam');
                    await jumpToCue(0, true);
                    return;
                  }
            
                  // Move to next dashakam if available
                  if (currentDashakam < totalDashakams) {
                    const nextD = String(currentDashakam + 1).padStart(3, '0');
                    console.log(`‚û°Ô∏è End of dashakam ${currentDashakam}, loading next ${nextD}`);
                    await loadDashakam(nextD, true);
                    if (cues.length > 0) await jumpToCue(0, true);
                    return;
                  }
            
                  // Otherwise stop playback
                  console.log('üõë End of final dashakam');
                  audio.pause();
                  currentCueIndex = -1;
                  updateCurrentInfo();
                }
              });
            
             /* ============================
                 Tiny helpers (these are exactly the same you had)
                 ============================ */
            
            // Updated themes with dashakam and mahapraana colors
const themes = {
  dark: {
    primary: "#1c1c1e",
    "primary-dark": "#121212",
    "primary-light": "#2c2c2e",
    bg: "#000000",
    text: "#ffffff",
    dashakam: "#ff2d55",       // Dashakam title
    mahapraana: "#ff4d4d"      // MahƒÅprƒÅ·πáa highlight in dark
  },
  light: {
    primary: "#f2f2f7",
    "primary-dark": "#d1d1d6",
    "primary-light": "#ffffff",
    bg: "#ffffff",
    text: "#1c1c1e",
    dashakam: "#d12a2a",       // Dashakam title
    mahapraana: "#ff2d55"      // Force pink for MahƒÅprƒÅ·πáa in light
  },
  pink: {
    primary: "#ff375f",
    "primary-dark": "#bf0f3f",
    "primary-light": "#ff8fa0",
    bg: "#fff0f2",
    text: "#3c003c",
    dashakam: "#e6004c",
    mahapraana: "#ff2d55"
  },
  purple: {
    primary: "#bf5af2",
    "primary-dark": "#7321bf",
    "primary-light": "#dab6f7",
    bg: "#f7f0ff",
    text: "#2c004c",
    dashakam: "#8000ff",
    mahapraana: "#ff2d55"      // pink for light readability
  },
  blue: {
    primary: "#0a84ff",
    "primary-dark": "#0050cc",
    "primary-light": "#a6d1ff",
    bg: "#f0f8ff",
    text: "#003366",
    dashakam: "#0066cc",
    mahapraana: "#ff2d55"
  },
  orange: {
    primary: "#ff9500",
    "primary-dark": "#cc7000",
    "primary-light": "#ffd49c",
    bg: "#fff6ed",
    text: "#663800",
    dashakam: "#ff5500",
    mahapraana: "#ff2d55"
  }
};

document.querySelectorAll(".theme-dot").forEach(dot => {
  dot.addEventListener("click", () => {
    const theme = dot.dataset.theme;
    const t = themes[theme];
    if (!t) return;

    // Apply CSS variables dynamically
    document.documentElement.style.setProperty("--accent", t.primary);
    document.documentElement.style.setProperty("--accent-soft", t["primary-light"] + "22");
    document.documentElement.style.setProperty("--page-bg", t.bg);
    document.documentElement.style.setProperty("--text-primary", t.text);
    document.documentElement.style.setProperty("--glass-strong", t["primary-dark"] + "b3");
    document.documentElement.style.setProperty("--glass-soft", t["primary-dark"] + "8c");

    // Dashakam title (theme-specific)
    document.documentElement.style.setProperty("--dashakam-color", t.dashakam);

    // MahƒÅprƒÅ·πáa highlighting: force pink for light mode
    const mahapraanaColor = document.body.classList.contains("light-theme") ? "#ff2d55" : t.mahapraana;
    document.documentElement.style.setProperty("--mahapraana-color", mahapraanaColor);

    // Mark active
    document.querySelectorAll(".theme-dot").forEach(d => d.classList.remove("active"));
    dot.classList.add("active");
  });
});
            
            function applyTheme(themeName) {
              const vars = themes[themeName];
              if (!vars) return;
            
              const root = document.documentElement;
            
              // ---------------- 1Ô∏è‚É£ Apply CSS variables ----------------
              for (const [key, val] of Object.entries(vars)) {
                root.style.setProperty(`--${key}`, val);
              }
            
              const accent = vars.primary;
            
              // ---------------- 2Ô∏è‚É£ Accent for form controls ----------------
              document.querySelectorAll('audio, input[type="range"]').forEach(el => {
                el.style.accentColor = accent;
              });
            
              // ---------------- 3Ô∏è‚É£ Buttons, icons, labels ----------------
              document.querySelectorAll(
              'button, button i, #audioControls i, .btn-label-small, #fontSmaller, #fontLarger'
            ).forEach(el => {
              el.style.color = vars.text;
            });
            
            
              // Main UI text elements
              const textElements = [
                verseDiv, splitWordsDiv, meaningDiv,
                timeDisplay, playPauseBtn, prevVerseBtn, nextVerseBtn,
                prevDashakamBtn, nextDashakamBtn,
                repeatVerseBtn, repeatDashakamBtn, speedBtn, muteBtn,
                gotoToggle, ...document.querySelectorAll('.group-select'),
                ...document.querySelectorAll('.accent-pill')
              ];
            
              textElements.forEach(el => {
                if (el) el.style.color = vars.text;
              });
            
              // Split words and accent-colored text
              if (splitWordsDiv) splitWordsDiv.style.color = accent;
            
              // ---------------- 4Ô∏è‚É£ Audio controls container ----------------
              const ac = document.getElementById('audioControls');
              if (ac) {
                const isLight = document.body.classList.contains('light-theme');
                ac.style.borderColor = vars["primary-dark"];
                ac.style.background = isLight
                  ? `linear-gradient(180deg, #fafafa 0%, ${vars["primary-light"] || vars.bg} 100%)`
                  : `linear-gradient(180deg, ${vars["primary-light"]} 0%, ${vars.bg} 100%)`;
              }
            
              // ---------------- 5Ô∏è‚É£ Save theme ----------------
              localStorage.setItem('theme', themeName);
            
              // ---------------- 6Ô∏è‚É£ Update theme dots ----------------
              const themeDots = document.getElementById('themeDots');
              if (themeDots) {
                themeDots.querySelectorAll('.theme-dot').forEach(dot => {
                  dot.classList.toggle('active', dot.dataset.theme === themeName);
                });
              }
            
              // ---------------- 7Ô∏è‚É£ Fix text/toggle contrast ----------------
              const mode = document.body.classList.contains('light-theme') ? 'light' : 'dark';
              adjustTextContrastForTheme(vars, mode);
              updateToggleColors();
              const smallerBtn = document.getElementById('fontSmaller');
            const largerBtn = document.getElementById('fontLarger');
            if (smallerBtn && largerBtn) {
              smallerBtn.style.color = vars.text;
              largerBtn.style.color = vars.text;
              smallerBtn.style.borderColor = vars.text === '#0b0b0b' ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.08)';
              largerBtn.style.borderColor = smallerBtn.style.borderColor;
            }
            }
            
            function applyMode(mode) {
              const body = document.body;
            
              if (mode === 'light') {
                body.classList.add('light-theme');
                themeModeLabel.textContent = 'Light';
                themeModeToggle.setAttribute('aria-pressed', 'true');
              } else {
                body.classList.remove('light-theme');
                themeModeLabel.textContent = 'Dark';
                themeModeToggle.setAttribute('aria-pressed', 'false');
              }
            
              localStorage.setItem('nm_theme_mode', mode);
            
              // Immediately reapply current theme so visuals update instantly
              const themeName = localStorage.getItem('theme') || 'green';
              applyTheme(themeName);
            
              // Update text & toggle colors
              const vars = themes[themeName];
              if (vars) updateTextColors(vars.text, mode);
              updateToggleColors();
            }
            
            // ‚úÖ Fixed version ‚Äî now readable in Light mode + Black theme
            function adjustTextContrastForTheme(vars, mode) {
              const isLight = mode === 'light';
              const currentTheme = localStorage.getItem('theme');
              const darkThemes = ['black', 'charcoal', 'maroon', 'brown'];
            
              let textColor, bgColor;
            
              if (isLight && darkThemes.includes(currentTheme)) {
                // Light mode + dark theme ‚Üí white bg, black text
                textColor = '#000000';
                bgColor = '#ffffff';
              } else if (!isLight) {
                // Dark mode ‚Üí use theme‚Äôs own vars
                textColor = vars.text;
                bgColor = vars.bg;
              } else {
                // Light mode + normal (non-dark) theme
                textColor = vars.text || '#000';
                bgColor = vars.bg || '#f8f8f8';
              }
            
              [verseDiv, splitWordsDiv, meaningDiv].forEach(el => {
                if (!el) return;
                el.style.color = textColor;
                el.style.backgroundColor = bgColor;
              });
            }
            
            function updateToggleColors() {
              const themeModeLabelEl = document.getElementById('themeModeLabel');
              const themeModeToggleEl = document.getElementById('themeModeToggle');
              if (!themeModeLabelEl || !themeModeToggleEl) return;
            
              const isLightMode = document.body.classList.contains('light-theme');
              const toggleTextColor = isLightMode ? '#000' : '#fff';
              const toggleBgColor = isLightMode ? '#fff' : '#000';
            
              themeModeLabelEl.style.color = toggleTextColor;
              themeModeToggleEl.style.color = toggleTextColor;
              themeModeToggleEl.style.backgroundColor = toggleBgColor;
            }
            
            function updateTextColors(color, mode) {
              const bg = mode === 'light' ? '#fff' : '#000';
              const textColor = color || (mode === 'light' ? '#000' : '#fff');
            
              const textElements = [
                verseDiv, splitWordsDiv, meaningDiv,
                timeDisplay, playPauseBtn, prevVerseBtn, nextVerseBtn,
                prevDashakamBtn, nextDashakamBtn,
                repeatVerseBtn, repeatDashakamBtn, speedBtn, muteBtn,
                gotoToggle,
                ...document.querySelectorAll('.group-select')
              ];
            
              textElements.forEach(el => {
                if (el) el.style.color = textColor;
              });
            
              document.body.style.backgroundColor = bg;
              updateToggleColors();
            }
            
            
            
            
            
            
            function initThemeDots(defaultTheme = 'green') {
              const themeDotsEl = document.getElementById('themeDots');
              if (!themeDotsEl) return;
            
              themeDotsEl.querySelectorAll('.theme-dot').forEach(btn => {
                const themeName = btn.dataset.theme;
                const themeVars = themes[themeName];
            
                // Ensure every button gets a color
                if(themeVars && themeVars.primary) {
                  btn.style.backgroundColor = themeVars.primary;
                  btn.style.border = '2px solid #fff'; // optional: better visibility
                } else {
                  // fallback color for missing theme
                  btn.style.backgroundColor = '#555';
                }
            
                // Add click handler
                btn.addEventListener('click', () => {
                  applyTheme(themeName);
                });
              });
            
              // Apply saved or default theme
              const saved = localStorage.getItem('theme') || defaultTheme;
              applyTheme(saved);
            }
            
            
            
              /*** Build UI and initial load ***/
              initThemeDots();
              initSpeedButton();
              initFontSelectors();
              initFontSizeControls();
              buildGroupGrid();
              loadDashakam('001').catch(e => console.error('initial loadDashakam error', e));
              loadDashakamTitles();
             
              function initSpeedButton() {
                const audioEl = document.getElementById('audio');
                const speedBtnEl = document.getElementById('speedBtn');
                if (!audioEl || !speedBtnEl) return;
                const speeds = [0.75, 1.0, 1.25, 1.5, 2.0];
                let currentIndex = 1;
                const savedSpeed = parseFloat(localStorage.getItem('playbackSpeed'));
                if (!isNaN(savedSpeed) && speeds.includes(savedSpeed)) {
                  audioEl.playbackRate = savedSpeed;
                  currentIndex = speeds.indexOf(savedSpeed);
                }
                function updateSpeedLabel() {
                  speedBtnEl.innerHTML = `<i class="fas fa-tachometer-alt"></i> ${speeds[currentIndex]}√ó`;
                }
                updateSpeedLabel();
                speedBtnEl.addEventListener('click', () => {
                  currentIndex = (currentIndex + 1) % speeds.length;
                  const newSpeed = speeds[currentIndex];
                  audioEl.playbackRate = newSpeed;
                  localStorage.setItem('playbackSpeed', newSpeed);
                  updateSpeedLabel();
                });
              }
            
              function initFontSelectors() {
                const uiFontContainer = document.getElementById('uiFontOptions');
                const devaFontContainer = document.getElementById('devaFontOptions');
            
                const savedUIFont = localStorage.getItem('uiFont') || '"Poppins", "Segoe UI", sans-serif';
                const savedDevaFont = localStorage.getItem('devaFont') || '"Tiro Devanagari Hindi", serif';
                applyFonts(savedUIFont, savedDevaFont);
            
                uiFontContainer.querySelectorAll('.font-swatch').forEach(btn => {
                  btn.classList.toggle('active', btn.dataset.font === savedUIFont);
                  btn.addEventListener('click', () => {
                    applyFonts(btn.dataset.font, savedDevaFont);
                    uiFontContainer.querySelectorAll('.font-swatch').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                  });
                });
            
                devaFontContainer.querySelectorAll('.font-swatch').forEach(btn => {
                  btn.classList.toggle('active', btn.dataset.font === savedDevaFont);
                  btn.addEventListener('click', () => {
                    applyFonts(savedUIFont, btn.dataset.font);
                    devaFontContainer.querySelectorAll('.font-swatch').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                  });
                });
              }
            
              function applyFontScale(scale) {
                document.documentElement.style.setProperty('--font-scale', scale);
                localStorage.setItem('fontScale', scale);
                syncSplitWordsSize();
              }
              function syncSplitWordsSize() {
                const verseEl = document.getElementById('verse');
                const splitEl = document.getElementById('splitWords');
                if (!verseEl || !splitEl) return;
                const verseSize = parseFloat(window.getComputedStyle(verseEl).fontSize);
                splitEl.style.fontSize = (verseSize * 0.7) + 'px';
              }
            
              function initFontSizeControls() {
                const smaller = document.getElementById('fontSmaller');
                const larger = document.getElementById('fontLarger');
                let scale = parseFloat(localStorage.getItem('fontScale')) || 1;
                applyFontScale(scale);
                smaller.addEventListener('click', () => {
                  scale = Math.max(0.7, scale - 0.1);
                  applyFontScale(scale);
                });
                larger.addEventListener('click', () => {
                  scale = Math.min(1.6, scale + 0.1);
                  applyFontScale(scale);
                });
              }
            
              function applyFonts(uiFont, devaFont) {
                document.documentElement.style.setProperty('--ui-font', uiFont);
                document.documentElement.style.setProperty('--deva-font', devaFont);
                localStorage.setItem('uiFont', uiFont);
                localStorage.setItem('devaFont', devaFont);
            
                document.querySelectorAll('#uiFontOptions .font-swatch').forEach(el => {
                  el.classList.toggle('active', el.dataset.font === uiFont);
                });
                document.querySelectorAll('#devaFontOptions .font-swatch').forEach(el => {
                  el.classList.toggle('active', el.dataset.font === devaFont);
                });
              }
            
              window.addEventListener('DOMContentLoaded', () => {
                const savedTheme = localStorage.getItem('theme') || 'green';
                const savedUiFont = localStorage.getItem('uiFont') || '"Poppins", "Segoe UI", sans-serif';
                const savedDevaFont = localStorage.getItem('devaFont') || '"Tiro Devanagari Hindi", serif';
                applyTheme(savedTheme);
                applyFonts(savedUiFont, savedDevaFont);
              });
            
              // safe guards for non-existing selects (keeps original behavior)
              const safeGet = id => document.getElementById(id) || { addEventListener: ()=>{}, value: '' };
              safeGet('themeSelect').addEventListener('change', e => applyTheme(e.target.value));
              safeGet('uiFontSelect').addEventListener('change', e => {
                const uiFont = e.target.value;
                const devaFont = localStorage.getItem('devaFont') || '"Tiro Devanagari Hindi", serif';
                applyFonts(uiFont, devaFont);
              });
              safeGet('devaFontSelect').addEventListener('change', e => {
                const devaFont = e.target.value;
                const uiFont = localStorage.getItem('uiFont') || '"Poppins", "Segoe UI", sans-serif';
                applyFonts(uiFont, devaFont);
              });
            
              /* ===========
                 Theme Mode Toggle (Dark <-> Light)
                 - This only affects CSS variables via body class.
                 - It does not change any sizes/layout (subtitle container unchanged).
                 ============ */
              const themeModeToggle = document.getElementById('themeModeToggle');
              const themeModeLabel = document.getElementById('themeModeLabel');
            
              // initialize from localStorage (default: dark)
              const savedMode = localStorage.getItem('nm_theme_mode') || 'dark';
              function applyMode(mode){
                if(mode === 'light'){
                  document.body.classList.add('light-theme');
                  themeModeLabel.textContent = 'Light';
                  themeModeToggle.setAttribute('aria-pressed','true');
                } else {
                  document.body.classList.remove('light-theme');
                  themeModeLabel.textContent = 'Dark';
                  themeModeToggle.setAttribute('aria-pressed','false');
                }
                localStorage.setItem('nm_theme_mode', mode);
              }
              applyMode(savedMode);
            
              themeModeToggle.addEventListener('click', () => {
                const now = document.body.classList.contains('light-theme') ? 'dark' : 'light';
                applyMode(now);
              });
            
            }); // end DOMContentLoaded
        </script>
        <script>
            document.getElementById("homeBtn").addEventListener("click", () => {
              window.location.href = "https://www.nivi108.com";
            });
            
            document.getElementById("vsnBtn").addEventListener("click", () => {
              window.open("https://nivinaveen108.github.io/vsn/", "_blank");
            });
        </script>
    </main>


    <!-- About Modal -->
    <div id="aboutModal" class="credits-modal" style="display:none;">
        <div class="credits-content">
            <h2>About</h2>

            <p><strong>NƒÅrƒÅya·πáƒ´yam Player</strong></p>
            <p>A devotional tool to listen, follow, and learn the verses of the <strong>NƒÅrƒÅya·πáƒ´yam</strong> with synchronized meanings, playback controls, and custom fonts/themes.</p>

            <h3>Shriman Narayaneeyam</h3>
            <p>16th-century Sanskrit poem by Melpathoor Narayana Bhattathiri, condensed from the Bhagavata Purana. 1036 verses in 100 chapters (dasakams). Legend: composed in 100 days while the poet was ill; completed on Nov 27, 1587.</p>

            <h4>Key Points</h4>
            <ul>
                <li>Origin: Kerala, 1560‚Äì1666 A.D.</li>
                <li>Content: Stories of Lord Vishnu, especially Krishna</li>
                <li>Structure: 1036 verses in 100 dasakams</li>
                <li>Title: "Narayaneeyam" = Narayana + Ayanam</li>
                <li>Significance: Devotional, literary, and philosophical guidance</li>
            </ul>

            <button id="aboutClose" class="modal-close-btn">Close</button>
        </div>
    </div>


    <!-- Credits Modal -->
    <div id="creditsModal" class="credits-modal" style="display:none;">
        <div class="credits-content">
            <h2>Credits</h2>

            <p>Audio:
                <a href="https://https://vedaclassonline.in/" target="_blank" rel="noopener noreferrer">
    Shri Viswanatha Raju P H
  </a>
            </p>

            <p>Texts:
                <a href="https://narayaneeyam-firststep.org/about.html" target="_blank" rel="noopener noreferrer">
    Smt. Asha Murarka
  </a>
            </p>

            <p>Translation:
                <a href="https://github.com/AI4Bharat/IndicTrans2" target="_blank" rel="noopener noreferrer">
    AI4Bharat/IndicTrans2
  </a>
            </p>
            <p>Unintentional Mistakes By: Naveen Natarajan</p>
            <p>UI/Design inspiration: Apple Music / iOS Glass UI</p>

            <button id="creditsClose" class="modal-close-btn">Close</button>
        </div>
    </div>


</body>

</html>
